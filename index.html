<!doctype html>
<html lang="ms">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SECURE ENTRY</title>

  <!-- Nunito (lebih bulat & tebal) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg1:#06130d;
      --bg2:#0a3a2a;
      --card:rgba(255,255,255,.08);
      --card2:rgba(255,255,255,.06);
      --stroke:rgba(255,255,255,.14);
      --text:#eafff5;
      --muted:rgba(234,255,245,.72);
      --accent:#33ff99;
      --accent2:#00d07a;
      --danger:#ff5a6a;
      --warn:#ffcc66;
      --ok:#5cffb2;
      --shadow: 0 18px 50px rgba(0,0,0,.45);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: Nunito, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      min-height:100vh;
      background:
        radial-gradient(1200px 800px at 20% 10%, rgba(51,255,153,.18), transparent 55%),
        radial-gradient(900px 700px at 80% 20%, rgba(0,208,122,.18), transparent 55%),
        linear-gradient(160deg, var(--bg1), var(--bg2));
    }
    header{
      position:sticky;
      top:0;
      z-index:50;
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      background: linear-gradient(180deg, rgba(6,19,13,.85), rgba(6,19,13,.55));
      border-bottom:1px solid var(--stroke);
    }
    .wrap{max-width:920px;margin:0 auto;padding:14px 14px}
    .title{
      display:flex;align-items:center;justify-content:space-between;gap:10px
    }
    .brand{
      display:flex;flex-direction:column;line-height:1.05
    }
    .brand strong{font-size:18px;letter-spacing:.6px}
    .brand span{font-size:12px;color:var(--muted)}
    .pill{
      font-size:12px;
      padding:8px 12px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.06);
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.08);
      color:var(--muted);
      user-select:none;
      white-space:nowrap;
    }
    main{padding:16px 14px 26px}
    .grid{max-width:920px;margin:0 auto;display:grid;gap:12px}
    .card{
      border:1px solid var(--stroke);
      background: linear-gradient(180deg, var(--card), var(--card2));
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:12px 14px;
      border-bottom:1px solid rgba(255,255,255,.10);
      display:flex;align-items:center;justify-content:space-between;gap:10px
    }
    .card .hd b{font-size:14px}
    .card .bd{padding:14px}
    .row{display:grid;gap:10px}
    @media(min-width:760px){
      .row.cols2{grid-template-columns:1fr 1fr}
      .row.cols3{grid-template-columns:1fr 1fr 1fr}
    }
    label{font-size:12px;color:var(--muted);display:block;margin:0 0 6px}
    input, select, textarea{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      color: var(--text);
      outline:none;
      font-size:14px;
    }
    input::placeholder, textarea::placeholder{color: rgba(234,255,245,.45)}
    input:focus, select:focus, textarea:focus{
      border-color: rgba(51,255,153,.55);
      box-shadow: 0 0 0 3px rgba(51,255,153,.14);
    }
    textarea{min-height:84px;resize:vertical}

    /* 3D buttons */
    .btnRow{display:flex;gap:10px;flex-wrap:wrap}
    .btn{
      border:0;
      cursor:pointer;
      padding:12px 14px;
      border-radius:14px;
      color:#042012;
      font-weight:800;
      letter-spacing:.4px;
      background: linear-gradient(180deg, #6bffc0, #1cff9d);
      box-shadow:
        0 10px 0 rgba(0,0,0,.35),
        0 18px 30px rgba(0,0,0,.35),
        inset 0 -2px 0 rgba(0,0,0,.18);
      transform: translateY(0);
      transition: transform .06s ease, box-shadow .06s ease, filter .15s ease;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .btn:active{
      transform: translateY(7px);
      box-shadow:
        0 3px 0 rgba(0,0,0,.35),
        0 10px 18px rgba(0,0,0,.30),
        inset 0 -2px 0 rgba(0,0,0,.14);
      filter:saturate(1.1);
    }
    .btn.secondary{
      color:var(--text);
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.14);
      box-shadow:
        0 10px 0 rgba(0,0,0,.25),
        0 16px 26px rgba(0,0,0,.35);
    }
    .btn.secondary:active{transform: translateY(7px)}
    .btn.danger{
      color:#2b060a;
      background: linear-gradient(180deg, #ff9aa4, #ff5a6a);
    }
    .btn.round{
      border-radius:999px;
      padding:12px 18px;
    }

    .status{
      display:flex;gap:10px;flex-wrap:wrap;align-items:center
    }
    .badge{
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      color: var(--muted);
    }
    .badge.ok{border-color:rgba(92,255,178,.35); color: rgba(92,255,178,.95)}
    .badge.warn{border-color:rgba(255,204,102,.35); color: rgba(255,204,102,.95)}
    .badge.bad{border-color:rgba(255,90,106,.35); color: rgba(255,90,106,.95)}
    .hint{font-size:12px;color:var(--muted);margin-top:8px}

    .preview{
      display:none;
      margin-top:10px;
      border-radius:14px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.14);
    }
    .preview img{display:block;width:100%;height:auto;background:#000}
    .small{font-size:12px;color:var(--muted)}
    .footer{
      max-width:920px;margin:0 auto;
      padding:12px 14px 18px;
      color: rgba(234,255,245,.55);
      font-size:12px;
      text-align:center;
    }

    /* Toast (no timer, auto hide bila user edit) */
    .toast{
      position:fixed;
      left:50%;
      transform: translateX(-50%);
      z-index:999;
      width:min(560px, calc(100vw - 24px));
      display:none;
      pointer-events:none;
    }
    .toast .inner{
      pointer-events:auto;
      margin:0 auto;
      background: rgba(10,58,42,.92);
      border: 1px solid rgba(255,255,255,.18);
      border-radius:14px;
      box-shadow: 0 18px 40px rgba(0,0,0,.45);
      padding:10px 12px;
      display:flex;align-items:flex-start;justify-content:space-between;gap:10px;
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
    }
    .toast b{font-size:13px}
    .toast p{margin:2px 0 0;font-size:12px;color:rgba(234,255,245,.8)}
    .toast button{
      border:0;background:transparent;color:rgba(234,255,245,.85);
      font-size:16px;cursor:pointer;line-height:1;padding:0 6px;
    }
  </style>
</head>
<body>
<header>
  <div class="wrap title">
    <div class="brand">
      <strong>SECURE ENTRY</strong>
      <span>REGISTER • ACCESS • SECURE</span>
    </div>
    <div class="pill" id="envPill">D1 • 120 HARI</div>
  </div>
</header>

<div class="toast" id="toast">
  <div class="inner">
    <div>
      <b id="toastTitle">Info</b>
      <p id="toastMsg">...</p>
    </div>
    <button id="toastClose" aria-label="Tutup">×</button>
  </div>
</div>

<main>
  <div class="grid">
    <section class="card">
      <div class="hd">
        <b>CARI REKOD</b>
        <div class="status">
          <span class="badge" id="badgeFound">—</span>
          <span class="badge" id="badgePhoto">—</span>
        </div>
      </div>
      <div class="bd">
        <div class="row cols2">
          <div>
            <label>Nombor MyKad / Passport / Reg No</label>
            <input id="searchKey" inputmode="text" placeholder="CONTOH: 860923-49-6973 / A1234567 / VKJ3889" />
            <div class="hint">Tip: Tekan “Cari” untuk autofill rekod terakhir dari D1.</div>
          </div>
          <div>
            <label>Jenis Carian (Optional)</label>
            <select id="searchType">
              <option value="">AUTO</option>
              <option value="DOC">DOC (MyKad/Passport)</option>
              <option value="REG">REG (No Pendaftaran)</option>
            </select>
            <div class="hint">AUTO akan cuba DOC dahulu, kemudian REG.</div>
          </div>
        </div>

        <div class="btnRow" style="margin-top:12px">
          <button class="btn round" id="btnSearch">CARI</button>
          <button class="btn secondary round" id="btnClear">CLEAR</button>
        </div>
      </div>
    </section>

    <section class="card">
      <div class="hd">
        <b>MAKLUMAT</b>
        <span class="small" id="lastUpdated">—</span>
      </div>
      <div class="bd">
        <div class="row cols2">
          <div>
            <label>Nama</label>
            <input id="name" placeholder="NAMA PENUH" />
          </div>
          <div>
            <label>No Telefon</label>
            <input id="phone" inputmode="tel" placeholder="01XXXXXXXX" />
          </div>
        </div>

        <div class="row cols2" style="margin-top:10px">
          <div>
            <label>No MyKad / Passport</label>
            <input id="docNo" placeholder="AUTO / MANUAL" />
          </div>
          <div>
            <label>No Pendaftaran Kenderaan</label>
            <input id="regNo" placeholder="AUTO / MANUAL" />
          </div>
        </div>

        <div class="row cols3" style="margin-top:10px">
          <div>
            <label>Kategori</label>
            <select id="category">
              <option value="">PILIH</option>
              <option>OWNER</option>
              <option>TENANT</option>
              <option>VISITOR</option>
              <option>DELIVERY</option>
              <option>CONTRACTOR</option>
              <option>TECHNICIAN</option>
              <option>OTHER</option>
            </select>
          </div>
          <div>
            <label>Tower</label>
            <select id="tower">
              <option value="">PILIH</option>
              <option>A</option>
              <option>B</option>
              <option>C</option>
              <option>NORTH</option>
              <option>SOUTH</option>
            </select>
          </div>
          <div>
            <label>Unit No (Jika perlu)</label>
            <input id="unitNo" placeholder="CONTOH: A-10-05" />
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <div>
            <label>Tujuan / Catatan</label>
            <textarea id="purpose" placeholder="CONTOH: DELIVERY FOOD / VISIT FRIEND / WORK ORDER"></textarea>
          </div>
        </div>

        <div class="row" style="margin-top:12px">
          <div class="btnRow">
            <button class="btn" id="btnCapture">AMBIL GAMBAR ID</button>
            <button class="btn secondary" id="btnPreview">PREVIEW</button>
            <button class="btn danger" id="btnRemovePhoto">REMOVE PHOTO</button>
          </div>
          <div class="hint">
            “AMBIL GAMBAR ID” hanya diperlukan bila rekod expired / tiada photo. “REMOVE PHOTO” akan paksa refresh pada carian seterusnya.
          </div>

          <div class="preview" id="previewBox">
            <img id="previewImg" alt="Preview ID" />
          </div>
        </div>

        <div class="btnRow" style="margin-top:14px">
          <button class="btn round" id="btnSubmit">SUBMIT</button>
        </div>

        <div class="hint" id="submitHint"></div>
      </div>
    </section>
  </div>
</main>

<div class="footer">Powered By MRED TECH</div>

<script>
(() => {
  "use strict";

  // ✅ SET URL WORKER ANDA DI SINI
  const WORKER_BASE_URL = "https://YOUR-WORKER.your-subdomain.workers.dev";

  const el = (id) => document.getElementById(id);

  const ui = {
    searchKey: el("searchKey"),
    searchType: el("searchType"),
    badgeFound: el("badgeFound"),
    badgePhoto: el("badgePhoto"),
    lastUpdated: el("lastUpdated"),
    name: el("name"),
    phone: el("phone"),
    docNo: el("docNo"),
    regNo: el("regNo"),
    category: el("category"),
    tower: el("tower"),
    unitNo: el("unitNo"),
    purpose: el("purpose"),
    btnSearch: el("btnSearch"),
    btnClear: el("btnClear"),
    btnCapture: el("btnCapture"),
    btnPreview: el("btnPreview"),
    btnRemovePhoto: el("btnRemovePhoto"),
    previewBox: el("previewBox"),
    previewImg: el("previewImg"),
    btnSubmit: el("btnSubmit"),
    submitHint: el("submitHint"),
    toast: el("toast"),
    toastTitle: el("toastTitle"),
    toastMsg: el("toastMsg"),
    toastClose: el("toastClose"),
  };

  // State
  const state = {
    found: false,
    hasPhoto: false,
    primaryKey: null,
    photoBase64: null,
    photoMime: null,
    lastRecord: null,
  };

  function normalizeKey(s){
    return (s || "").trim().toUpperCase();
  }

  function showToastNear(elInput, title, msg){
    ui.toastTitle.textContent = title;
    ui.toastMsg.textContent = msg;

    const r = elInput.getBoundingClientRect();
    // Letak toast betul-betul atas field
    const top = Math.max(10, window.scrollY + r.top - 64);
    ui.toast.style.top = top + "px";
    ui.toast.style.display = "block";
  }
  function hideToast(){
    ui.toast.style.display = "none";
  }

  ui.toastClose.addEventListener("click", hideToast);

  // Auto hide toast bila user mula edit mana-mana field
  const inputsToHideToast = [ui.searchKey, ui.name, ui.phone, ui.docNo, ui.regNo, ui.unitNo, ui.purpose];
  inputsToHideToast.forEach(x => x.addEventListener("input", hideToast));

  function setBadge(elBadge, text, cls){
    elBadge.className = "badge" + (cls ? " " + cls : "");
    elBadge.textContent = text;
  }

  function resetForm(keepSearch=false){
    state.found = false;
    state.hasPhoto = false;
    state.primaryKey = null;
    state.photoBase64 = null;
    state.photoMime = null;
    state.lastRecord = null;

    if(!keepSearch) ui.searchKey.value = "";
    ui.name.value = "";
    ui.phone.value = "";
    ui.docNo.value = "";
    ui.regNo.value = "";
    ui.category.value = "";
    ui.tower.value = "";
    ui.unitNo.value = "";
    ui.purpose.value = "";

    ui.previewImg.src = "";
    ui.previewBox.style.display = "none";

    setBadge(ui.badgeFound, "—", "");
    setBadge(ui.badgePhoto, "—", "");
    ui.lastUpdated.textContent = "—";
    ui.submitHint.textContent = "";
  }

  async function api(path, opts={}){
    const url = WORKER_BASE_URL.replace(/\/+$/,"") + path;
    const res = await fetch(url, {
      ...opts,
      headers: {
        "Content-Type": "application/json",
        ...(opts.headers || {})
      }
    });
    const text = await res.text();
    let data;
    try { data = JSON.parse(text); } catch(e){ data = { ok:false, error:"Invalid JSON from server", raw:text }; }
    if(!res.ok || data.ok === false){
      const err = data?.error || ("HTTP " + res.status);
      throw new Error(err);
    }
    return data;
  }

  function applyRecord(rec){
    state.lastRecord = rec;

    ui.name.value = rec.name || "";
    ui.phone.value = rec.phone || "";
    ui.docNo.value = rec.docNo || "";
    ui.regNo.value = rec.regNo || "";
    ui.category.value = rec.category || "";
    ui.tower.value = rec.tower || "";
    ui.unitNo.value = rec.unitNo || "";
    ui.purpose.value = ""; // purpose biasanya baru

    const updated = rec.updatedAt ? new Date(rec.updatedAt).toLocaleString() : null;
    ui.lastUpdated.textContent = updated ? ("Last: " + updated) : "—";
  }

  async function doSearch(){
    const key = normalizeKey(ui.searchKey.value);
    if(!key){
      showToastNear(ui.searchKey, "REQUIRED", "Sila isi nombor MyKad/Passport/Reg No untuk carian.");
      return;
    }
    setBadge(ui.badgeFound, "Searching...", "");
    setBadge(ui.badgePhoto, "—", "");
    ui.submitHint.textContent = "";

    try{
      const type = ui.searchType.value || "";
      const qs = new URLSearchParams({ key });
      if(type) qs.set("type", type);
      const data = await api("/api/search?" + qs.toString(), { method:"GET" });

      state.found = !!data.exist;
      state.hasPhoto = !!data.hasPhoto;
      state.primaryKey = data.primaryKey || null;

      if(state.found){
        setBadge(ui.badgeFound, "RECORD FOUND", "ok");
        setBadge(ui.badgePhoto, state.hasPhoto ? "PHOTO OK" : "PHOTO EXPIRED", state.hasPhoto ? "ok" : "warn");
        if(data.record) applyRecord(data.record);

        if(data.record?.photoUrl){
          ui.previewImg.src = data.record.photoUrl;
        } else {
          ui.previewImg.src = "";
          ui.previewBox.style.display = "none";
        }

        ui.submitHint.textContent = state.hasPhoto
          ? "Rekod dijumpai. Anda boleh terus SUBMIT tanpa ambil gambar."
          : "Rekod dijumpai tetapi photo tiada/expired. Sila AMBIL GAMBAR ID untuk refresh.";
      } else {
        setBadge(ui.badgeFound, "NOT FOUND", "bad");
        setBadge(ui.badgePhoto, "—", "");
        ui.lastUpdated.textContent = "—";
        ui.submitHint.textContent = "Tiada rekod. Isi maklumat dan AMBIL GAMBAR ID (jika perlu) sebelum SUBMIT.";
      }
    }catch(err){
      setBadge(ui.badgeFound, "ERROR", "bad");
      setBadge(ui.badgePhoto, "—", "");
      showToastNear(ui.searchKey, "ERROR", err.message || "Search error");
    }
  }

  async function capturePhoto(){
    // Simple capture using file input fallback (lebih stabil di Android/iPhone)
    const input = document.createElement("input");
    input.type = "file";
    input.accept = "image/*";
    input.capture = "environment";
    input.onchange = async () => {
      const file = input.files && input.files[0];
      if(!file) return;
      if(file.size > 6 * 1024 * 1024){
        showToastNear(ui.btnCapture, "FILE TOO LARGE", "Sila ambil semula (maks 6MB).");
        return;
      }
      const mime = file.type || "image/jpeg";
      const base64 = await fileToBase64(file);
      state.photoBase64 = base64;
      state.photoMime = mime;

      ui.previewImg.src = "data:" + mime + ";base64," + base64;
      ui.previewBox.style.display = "block";
      ui.submitHint.textContent = "Gambar siap. Tekan SUBMIT untuk hantar.";
    };
    input.click();
  }

  function fileToBase64(file){
    return new Promise((resolve,reject)=>{
      const r = new FileReader();
      r.onload = () => {
        const s = String(r.result || "");
        const idx = s.indexOf("base64,");
        resolve(idx >= 0 ? s.slice(idx+7) : s);
      };
      r.onerror = reject;
      r.readAsDataURL(file);
    });
  }

  function togglePreview(){
    if(!ui.previewImg.src){
      showToastNear(ui.btnPreview, "NO PREVIEW", "Tiada gambar untuk dipreview.");
      return;
    }
    ui.previewBox.style.display = (ui.previewBox.style.display === "block") ? "none" : "block";
  }

  function removePhoto(){
    state.photoBase64 = null;
    state.photoMime = null;
    ui.previewImg.src = "";
    ui.previewBox.style.display = "none";
    showToastNear(ui.btnRemovePhoto, "PHOTO REMOVED", "Photo temp di frontend dibuang. Submit akan dihantar tanpa photo.");
  }

  async function doSubmit(){
    // Minimal required: either docNo or regNo (ikut flow Secure Entry)
    const payload = {
      name: normalizeKey(ui.name.value),
      phone: normalizeKey(ui.phone.value),
      docNo: normalizeKey(ui.docNo.value),
      regNo: normalizeKey(ui.regNo.value),
      category: normalizeKey(ui.category.value),
      tower: normalizeKey(ui.tower.value),
      unitNo: normalizeKey(ui.unitNo.value),
      purpose: normalizeKey(ui.purpose.value),
      // photo optional
      photoBase64: state.photoBase64,
      photoMime: state.photoMime,
      // hint key from search (optional)
      searchedKey: normalizeKey(ui.searchKey.value),
    };

    if(!payload.docNo && !payload.regNo){
      showToastNear(ui.docNo, "REQUIRED", "Sila isi sekurang-kurangnya DOC (MyKad/Passport) atau REG (No Pendaftaran).");
      return;
    }

    // Jika record found tapi photo expired, galakkan ambil gambar
    if(state.found && !state.hasPhoto && !payload.photoBase64){
      showToastNear(ui.btnCapture, "PHOTO REQUIRED", "Rekod expired. Sila AMBIL GAMBAR ID untuk refresh.");
      return;
    }

    ui.btnSubmit.disabled = true;
    ui.btnSubmit.textContent = "SUBMITTING...";
    try{
      const data = await api("/api/submit", { method:"POST", body: JSON.stringify(payload) });

      // reset photo temp
      state.photoBase64 = null;
      state.photoMime = null;

      showToastNear(ui.btnSubmit, "SUCCESS", "Submit berjaya. Rekod telah dikemaskini.");
      // refresh search result
      if(payload.docNo) ui.searchKey.value = payload.docNo;
      else if(payload.regNo) ui.searchKey.value = payload.regNo;
      await doSearch();
    }catch(err){
      showToastNear(ui.btnSubmit, "SUBMIT ERROR", err.message || "Submit gagal");
    }finally{
      ui.btnSubmit.disabled = false;
      ui.btnSubmit.textContent = "SUBMIT";
    }
  }

  ui.btnSearch.addEventListener("click", doSearch);
  ui.btnClear.addEventListener("click", () => resetForm(false));
  ui.btnCapture.addEventListener("click", capturePhoto);
  ui.btnPreview.addEventListener("click", togglePreview);
  ui.btnRemovePhoto.addEventListener("click", removePhoto);
  ui.btnSubmit.addEventListener("click", doSubmit);

  // Enter untuk search
  ui.searchKey.addEventListener("keydown", (e)=>{
    if(e.key === "Enter"){
      e.preventDefault();
      doSearch();
    }
  });

  // init
  resetForm(true);
})();
</script>
</body>
</html>
